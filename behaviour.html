<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="value-observer.html">

<script>
    /**
     * `flowbased-behaviour`
     * Connect events from components to other components or to properties without coding
     *
     *
     * @author veith
     * @demo demo/index.html
     *
     * @polymerBehavior PolymerFlowBasedProgramming
     */
    PolymerFlowBasedProgramming = {
        properties: {
            _PolymerFlowBasedProgrammingEvents: {
                type: Array,
                value: function () {
                    return [];
                }()
            }
        },
        attached: function () {
            var self = this;
            var wirebundle = {};

            // get all elements which live in the host
            Polymer.dom(this.root).querySelectorAll('*').forEach(function (element) {
                for (var i = 0; i < element.attributes.length; i++) {
                    // collect receiving tags
                    if (element.attributes[i].name.startsWith('Æ’-')) {
                        // get method name and convert to camel case
                        var methodname = element.attributes[i].name.substr(2).replace(/-([a-z])/g, function (g) {
                            return g[1].toUpperCase();
                        });
                        var mwire = element.attributes[i].value;

                        // collect receiver
                        mwire.split(',').forEach(function (w) {
                            var receivingWire = w.trim();
                            if (!wirebundle[receivingWire]) {
                                wirebundle[receivingWire] = [];
                            }
                            wirebundle[receivingWire].push({"element": element, "method": methodname});
                        });

                    }

                    // collect sending tags
                    if (element.attributes[i].name.startsWith('@-')) {

                        var eventname = element.attributes[i].name.substr(2);
                        var useSetter = false;
                        var wire;

                        if (element.attributes[i].value.startsWith('((')) {
                            wire = element.attributes[i].value.substring(2, element.attributes[i].value.length - 2);
                            useSetter = true;
                        } else {
                            wire = element.attributes[i].value;
                        }


                        /**
                         * register event on current element
                         * @param eventname
                         */
                        function registerEvent(eventname) {
                            var handler = function (e) {
                                // Werte setzen
                                if (useSetter) {
                                    self.set(wire, e.detail, self);
                                } else {

                                    // Methoden aufrufen
                                    if (wirebundle[wire]) {
                                        wirebundle[wire].forEach(function (receiver) {
                                            if (typeof receiver.element[receiver.method] === 'function') {
                                                receiver.element[receiver.method](e.detail);
                                            } else {
                                                console.warn(receiver.method + ' is neither a listener nor a function of ' + receiver.element.nodeName)
                                            }

                                        });
                                    }
                                }
                            };

                            element.addEventListener(eventname, handler, false);
                            self._PolymerFlowBasedProgrammingEvents.push({
                                "element": element,
                                "event": eventname,
                                "handler": handler
                            });
                        }

                        // register click on tap event like polymer
                        if (eventname === 'tap') {
                            eventname = 'click';
                        }

                        registerEvent(eventname);

                    }
                }
            })

        },
        detached: function () {
            var self = this;
            // remove event listeners
            this._PolymerFlowBasedProgrammingEvents.forEach(function (e) {
                e.element.removeEventListener(e.event, e.hadler);
            })
        }

    };
</script>
