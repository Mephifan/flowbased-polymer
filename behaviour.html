<link rel="import" href="../polymer/polymer.html">

<script>
    /**
     * `flowbased-behaviour`
     * Connect events from components to other components or to properties without coding
     *
     * Usage:
     * - add a ```@ƒ-<event>="<connector/property>"``` to emmiting component.
     * - add a ```ƒ-<function/event>="<connector/property>"``` to the receiving component.
     *
     * event.detail will be passed to the receiver function and to the proprty <connector/property>
     *
     * @author veith
     * @demo demo/index.html
     *
     * @polymerBehavior PolymerFlowBasedProgramming
     */
    PolymerFlowBasedProgramming = {
        properties: {
            _PolymerFlowBasedProgrammingEvents: {
                type: Array,
                value: function () {
                    return [];
                }()
            }
        },
        attached: function () {
            var self = this;
            var methodwirebundle = {};

            // get all elements which live in the host
            Polymer.dom(this.root).querySelectorAll('*').forEach(function (element) {
                for (var i = 0; i < element.attributes.length; i++) {
                    // collect receiving tags
                    if (element.attributes[i].name.startsWith('ƒ-')) {
                        // get method name and convert to camel case
                        var methodname = element.attributes[i].name.substr(2).replace(/-([a-z])/g, function (g) {
                            return g[1].toUpperCase();
                        });
                        var mwire = element.attributes[i].value;
                        if (!methodwirebundle[mwire]) {
                            methodwirebundle[mwire] = [];
                        }
                        // collect receiver
                        methodwirebundle[mwire].push({"element": element, "method": methodname});
                    }

                    // collect sending tags
                    if (element.attributes[i].name.startsWith('@ƒ-')) {

                        var eventname = element.attributes[i].name.substr(3);
                        var useSetter = false;
                        var wire;

                        if (element.attributes[i].value.startsWith('{')) {
                            wire = element.attributes[i].value.substring(1, element.attributes[i].value.length - 1);
                            useSetter = true;
                        } else {
                            wire = element.attributes[i].value;
                        }


                        /**
                         * register event on current element
                         * @param eventname
                         */
                        function registerEvent(eventname) {
                            var handler = function (e) {
                                // Werte setzen
                                if (useSetter) {
                                    self.set(wire, e.detail, self);
                                } else {

                                    // Methoden aufrufen
                                    if (methodwirebundle[wire]) {
                                        methodwirebundle[wire].forEach(function (receiver) {
                                            if (typeof receiver.element[receiver.method] === 'function') {
                                                receiver.element[receiver.method](e.detail);
                                            } else {
                                                console.warn(receiver.method + ' is neither a listener nor a function of ' + receiver.element.nodeName)
                                            }

                                        });
                                    }
                                }
                            };

                            element.addEventListener(eventname, handler, false);
                            self._PolymerFlowBasedProgrammingEvents.push({
                                "element": element,
                                "event": eventname,
                                "handler": handler
                            });
                        }

                        registerEvent(eventname);
                        // register click on tap event like polymer
                        if (eventname === 'tap') {
                            registerEvent('click');
                        }
                    }
                }
            })

        },
        detached: function () {
            var self = this;
            // remove event listeners
            this._PolymerFlowBasedProgrammingEvents.forEach(function (e) {
                e.element.removeEventListener(e.event, e.hadler);
            })
        }

    };
</script>
